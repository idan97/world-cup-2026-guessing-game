// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Stage {
  GROUP
  R32
  R16
  QF
  SF
  F
}

enum Outcome {
  W
  D
  L
}

enum LeagueRole {
  ADMIN
  PLAYER
}

// ============================================
// TEAMS & STANDINGS
// ============================================

model Team {
  id         String   @id @default(cuid())
  fifaCode   String   @unique // "1", "2", "3", etc.
  name       String
  nameHebrew String?
  
  // Group assignment (null for teams not yet qualified)
  groupLetter   String?  // A-L
  groupPosition Int?     // 1-4 (initial seeding position)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  team1Matches       Match[]            @relation("Team1Matches")
  team2Matches       Match[]            @relation("Team2Matches")
  wonMatches         Match[]            @relation("WonMatches")
  groupStandings     GroupStanding[]
  thirdPlaceRankings ThirdPlaceRanking[]
  advancePicks       AdvancePick[]

  @@index([fifaCode])
  @@index([groupLetter])
  @@map("teams")
}

model GroupStanding {
  id            String   @id @default(cuid())
  groupLetter   String   // A-L
  position      Int      // 1-4 (current position after matches played)
  teamId        String?  // null until determined
  
  // Calculated from match results
  played        Int      @default(0)
  wins          Int      @default(0)
  draws         Int      @default(0)
  losses        Int      @default(0)
  goalsFor      Int      @default(0)
  goalsAgainst  Int      @default(0)
  goalDiff      Int      @default(0)
  points        Int      @default(0)
  
  updatedAt     DateTime @updatedAt
  
  team Team? @relation(fields: [teamId], references: [id])
  
  @@unique([groupLetter, position])
  @@index([groupLetter])
  @@index([points, goalDiff, goalsFor]) // For ranking calculation
  @@map("group_standings")
}

model ThirdPlaceRanking {
  id          String   @id @default(cuid())
  groupLetter String   @unique
  teamId      String?
  rank        Int?     // 1-8
  
  // Stats from group stage (for ranking)
  points       Int      @default(0)
  goalDiff     Int      @default(0)
  goalsFor     Int      @default(0)
  
  updatedAt    DateTime @updatedAt
  
  team Team? @relation(fields: [teamId], references: [id])
  
  @@index([rank])
  @@map("third_place_rankings")
}

// ============================================
// MATCHES
// ============================================

model Match {
  id          String   @id @default(cuid())
  matchNumber Int      @unique // 1-104
  
  stage       Stage
  
  // Team codes (placeholders like "1A", "2B", "3-ABCDF", "W73")
  team1Code   String
  team2Code   String
  team1Name   String?
  team2Name   String?
  
  // Actual teams (filled when determined from group results)
  team1Id     String?
  team2Id     String?
  
  // Results (null before match is played)
  team1Score  Int?
  team2Score  Int?
  winnerId    String?
  
  isFinished  Boolean  @default(false)
  
  // Scheduling
  scheduledAt DateTime
  playedAt    DateTime?
  
  // Venue
  venue       String?
  venueCode   Int?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  team1       Team?       @relation("Team1Matches", fields: [team1Id], references: [id])
  team2       Team?       @relation("Team2Matches", fields: [team2Id], references: [id])
  winner      Team?       @relation("WonMatches", fields: [winnerId], references: [id])
  matchPicks  MatchPick[]

  @@index([matchNumber])
  @@index([stage])
  @@index([isFinished])
  @@index([scheduledAt])
  @@map("matches")
}

// ============================================
// AUTH & MEMBERSHIP
// ============================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  displayName String
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  leagues  LeagueMember[]
  messages LeagueMessage[]
  form     Form?

  @@map("users")
}

model League {
  id          String   @id @default(cuid())
  name        String
  description String?
  joinCode    String   @unique
  createdAt   DateTime @default(now())

  // Relations
  members   LeagueMember[]
  allowList LeagueAllowEmail[]
  messages  LeagueMessage[]

  @@map("leagues")
}

model LeagueMember {
  leagueId String
  userId   String
  role     LeagueRole
  joinedAt DateTime   @default(now())

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([leagueId, userId])
  @@map("league_members")
}

model LeagueAllowEmail {
  id       Int        @id @default(autoincrement())
  leagueId String
  email    String
  role     LeagueRole
  addedAt  DateTime   @default(now())

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([leagueId, email])
  @@map("league_allow_emails")
}

model LeagueMessage {
  id        String   @id @default(cuid())
  leagueId  String
  authorId  String
  title     String
  body      String   // markdown
  pinned    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("league_messages")
}

// ============================================
// PREDICTION FORMS
// ============================================

model Form {
  id          String    @id @default(cuid())
  ownerId     String    @unique
  nickname    String
  submittedAt DateTime?
  isFinal     Boolean   @default(false)
  totalPoints Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  owner           User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  matchPicks      MatchPick[]
  advancePicks    AdvancePick[]
  topScorerPicks  TopScorerPick[]
  scoringRuns     ScoringRun[]

  @@map("forms")
}

model MatchPick {
  formId      String
  matchId     String  // Changed to String to match Match.id
  predScoreA  Int
  predScoreB  Int
  predOutcome Outcome

  // Relations
  form  Form  @relation(fields: [formId], references: [id], onDelete: Cascade)
  match Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@id([formId, matchId])
  @@index([matchId])
  @@map("match_picks")
}

model AdvancePick {
  formId String
  stage  Stage
  teamId String

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([formId, stage, teamId])
  @@index([stage, teamId])
  @@map("advance_picks")
}

model TopScorerPick {
  formId     String
  playerName String

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@id([formId])
  @@map("top_scorer_picks")
}

model ScoringRun {
  id      Int      @id @default(autoincrement())
  formId  String
  runAt   DateTime @default(now())
  delta   Int
  details Json

  // Relations
  form Form @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@map("scoring_runs")
}

